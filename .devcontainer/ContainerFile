# Image
FROM docker.io/library/alpine:latest

# copy setup scripts and precompiled programs
# always chmod +x the scripts locally
# chmod +x in the dockerfile bloats the image size
COPY scripts/* /usr/local/bin/

# copy configs
# doas.conf is for doas
# customshi.fish is for generic fish config
# rust-path.fish.bak is for setup-rust
COPY configs/doas.conf /etc/
COPY configs/customshi.fish /etc/fish/conf.d/
COPY configs/rust-path.fish.bak /etc/fish/conf.d/

# create vscode user
## reference: https://github.com/devcontainers/images/blob/main/src/base-alpine/.devcontainer/devcontainer.json
## reference: https://github.com/devcontainers/features/tree/main/src/common-utils

RUN { addgroup -S wheel || true; } && \
    addgroup -g 1000 vscode && \
    adduser -u 1000 -G vscode -D vscode && \
    addgroup vscode wheel && \
    groups vscode

# install and configure passwordless doas for :wheel
RUN apk add --no-cache doas doas-sudo-shim

# Install the basics
RUN apk add --no-cache fish git curl nano pfetch-rs

# Install host-spawn
RUN curl -fsSL https://github.com/1player/host-spawn/releases/latest/download/host-spawn-x86_64 \
    -o /usr/local/bin/host-spawn && \
    ln -s /usr/local/bin/host-spawn /usr/local/bin/hpwn

# Switch to user
USER vscode
